services:
  service-python:
    build: ./service-python
    container_name: service-python
    environment:
      - PORT=8001
    ports:
      - "${PY_PORT:-8001}:8001"
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/healthz', timeout=2)"]
      interval: 10s
      timeout: 3s
      retries: 6
      start_period: 15s
    restart: unless-stopped
    networks:
      - hpag-net

  service-node:
    build: ./service-node
    container_name: service-node
    environment:
      - PORT=8002
    ports:
      - "${NODE_PORT:-8002}:8002"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8002/healthz > /dev/null || exit 1"]
      interval: 10s
      timeout: 2s
      retries: 6
      start_period: 5s
    restart: unless-stopped
    networks:
      - hpag-net

  api-gateway-go:
    build: ./api-gateway-go
    container_name: api-gateway-go
    environment:
      PY_SERVICE_URL: http://service-python:8001
      NODE_SERVICE_URL: http://service-node:8002
      PORT: 8080
      RATE_LIMIT_ENABLED: "true"  # toggle limiter on/off
      # Global limiter (whole gateway)
      GLOBAL_RPS: "1000"           # tokens added per second
      GLOBAL_BURST: "500"         # bucket capacity for short bursts
      # Per-client limiter (by client IP / X-Forwarded-For)
      CLIENT_RPS: "10000"
      CLIENT_BURST: "10000"
      # Cleanup idle client buckets (minutes)
      RL_CLEANUP_MINUTES: "10"
      CACHE_ENABLED: "true"
      CACHE_TTL_SECONDS: "30"     # default TTL for cacheable responses
      CACHE_MAX_ENTRIES: "10000"  # soft cap; simple map with GC
      CACHE_MAX_BODY_BYTES: "1048576"  # 1 MiB; skip caching larger bodies
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    depends_on:
      service-python:
        condition: service_started
      service-node:
        condition: service_started
    restart: unless-stopped
    networks:
      - hpag-net

networks:
  hpag-net:
    driver: bridge
